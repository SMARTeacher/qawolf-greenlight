import { createEnvironmentVariables } from "./createEnvironmentVariables";
import { findOrCreateEnvironment } from "./findOrCreateEnvironment";
import { findOrCreateTrigger } from "./findOrCreateTrigger";
import { findRepositoryIdByName } from "./findRepositoryIdByName";
import { getEnvironmentVariablesFromEnvironment } from "./getEnvironmentVariablesFromEnvironment";
import { getTagsFromGenericTriggerInEnvironment } from "./getTagsFromEnvironment";
export const createEnvironmentAction = async (deps, apiConfig, { branch, headRepoFullName, deploymentUrl, qaWolfTeamId, pr, variables, baseEnvironmentId, }) => {
    deps.log.info("Creating environment for pull request...");
    const environmentId = await findOrCreateEnvironment(deps, apiConfig, {
        baseEnvironmentId,
        branch,
        pr,
        qaWolfTeamId,
    });
    deps.log.info(`Environment created with ID: ${environmentId}`);
    const baseEnvironmentVariablesJSON = baseEnvironmentId
        ? await getEnvironmentVariablesFromEnvironment(deps, apiConfig, {
            environmentId: baseEnvironmentId,
        })
        : {};
    if (typeof baseEnvironmentVariablesJSON !== "object") {
        deps.log.error("baseEnvironmentVariablesJSON is not an object");
        throw new Error("baseEnvironmentVariablesJSON is not an object");
    }
    const combinedEnvironmentVariables = {
        ...baseEnvironmentVariablesJSON,
        ...variables,
        ...(deploymentUrl ? { URL: deploymentUrl } : {}),
    };
    deps.log.info("Creating environment variables...");
    await createEnvironmentVariables(deps, apiConfig, {
        environmentId,
        variables: combinedEnvironmentVariables,
    });
    deps.log.info(`Environment variables created for environment ID: ${environmentId}`);
    deps.log.info("Retrieving repository ID...");
    const repositoryId = await findRepositoryIdByName(deps, apiConfig, {
        headRepoFullName,
    });
    deps.log.info(repositoryId
        ? `Repository ID retrieved: ${repositoryId}`
        : "Repository not integrated with QA Wolf, enable it in the settings page to get PR comments and checks.");
    const tags = baseEnvironmentId
        ? await getTagsFromGenericTriggerInEnvironment(deps, apiConfig, {
            environmentId: baseEnvironmentId,
        })
        : undefined;
    deps.log.info(`Tags retrieved: ${tags?.map((tag) => tag.name).join(", ")}`);
    deps.log.info("Creating trigger for deployment...");
    await findOrCreateTrigger(deps, apiConfig, {
        branch,
        environmentId,
        pr,
        qaWolfTeamId,
        repositoryId,
        tags,
    });
};
//# sourceMappingURL=createEnvironmentAction.js.map